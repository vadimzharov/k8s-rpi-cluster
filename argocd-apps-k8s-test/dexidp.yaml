apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dexidp
  namespace: argocd
  annotations:
    avp.kubernetes.io/path: "k8secrets/dex"   
spec:
  project: k8s-rpi-apps
  source:
    helm:
      values: |
        config:
          issuer: <dexhostname>
        storage:
          type: kubernetes
          config:
            inCluster: true          
        oauth2:
          responseTypes: ["code", "token", "id_token"]
          skipApprovalScreen: true
        connectors:
          - type: github
            id: github
            name: GitHub
            config:
              clientID: "{{ .Env.GITHUB_CLIENT_ID }}"
              clientSecret: "{{ .Env.GITHUB_CLIENT_SECRET }}"
              redirectURI: <dexhostname>/callback
              orgs:
                - name: <oauthorg>
        envFrom:
          - secretRef: 
              name: github-oauth-creds
        configSecret:
          name: dex
    repoURL: https://charts.dexidp.io
    chart: dex
    targetRevision: 0.6.3
  destination:
    server: https://kubernetes.default.svc
    namespace: dexidp
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true